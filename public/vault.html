<!-- vault.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBzkTSn1Xec-kGSHPahtCQ-nhmni3qzAIs",
    authDomain: "neuraplumb-temp.firebaseapp.com",
    projectId: "neuraplumb-temp",
    storageBucket: "neuraplumb-temp.appspot.com",
    messagingSenderId: "496029226738",
    appId: "1:496029226738:web:f837e91b9df82ad78b1b9b"
  };
  firebase.initializeApp(firebaseConfig);
</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vault Placeholder</title>
</head>
<body>
  <img id="previewImage" src="" alt="Job Preview" width="300" style="display: none;" />
  <div id="scoreDisplay" style="margin-top: 20px;"></div>

  <h1>Vault Placeholder</h1>
  <p>This is where TrustQuote will live.</p>

  <h2>Your Vault</h2>
  <div id="vault"></div>

  <script type="module">
    const params = new URLSearchParams(window.location.search);
     const pdfScript = document.createElement("script");
    pdfScript.src = "https://rawgit.com/eKoopmans/html2pdf/master/dist/html2pdf.bundle.js";
    document.head.appendChild(pdfScript);
    const imageUrl = params.get("imgUrl");
    const score = params.get("score");
    const jobType = params.get("jobType");
    const profile = params.get("profile") || "standard";

    // === Insert before <div id="vault"></div> ===
    const filterBar = document.createElement("div");
    filterBar.style.marginBottom = "20px";
    filterBar.innerHTML = `
      <label>Filter: </label>
      <select id="jobFilter">
        <option value="">All Jobs</option>
        <option value="Repipe">Repipe</option>
        <option value="Sewer">Sewer</option>
        <option value="WaterHeater">WaterHeater</option>
        <option value="Drain">Drain</option>
        <option value="Inspection">Inspection</option>
      </select>
      <select id="profileFilter">
        <option value="">All Profiles</option>
        <option value="standard">Standard</option>
        <option value="premium">Premium</option>
      </select>
      <select id="tagFilter">
        <option value="">All Tags</option>
        <option value="Elite">‚úÖ Elite</option>
        <option value="NeedsReview">‚ö†Ô∏è Needs Review</option>
        <option value="Reviewed">üß† Reviewed</option>
      </select>
    `;
    document.body.insertBefore(filterBar, document.getElementById("vault"));

     // === üîß GLOBAL CONFIG MAP ===
    const NeuraConfig = {
      scoreDifficultyMap: {
        "1": "Extreme",
        "2": "High",
        "3": "Moderate",
        "4": "Light",
        "5": "Simple"
      },
      quoteSummaryMap: {
        "1": "This job may involve severe failure risks and should be reviewed immediately.",
        "2": "This install falls below expected standards. Review is recommended.",
        "3_repipe": "Repiping jobs at this difficulty often involve trenching, rerouting, and permit compliance.",
        "3": "This job has moderate complexity with some risk factors.",
        "4": "Above average quality with minimal labor complexity.",
        "5": "This install meets elite standards. Minimal labor expected."
      },
      priceRanges: {
        standard: {
          "1": "$2,500 ‚Äì $4,000",
          "2": "$1,800 ‚Äì $2,800",
          "3_repipe": "$1,600 ‚Äì $2,400",
          "3": "$1,200 ‚Äì $1,800",
          "4": "$800 ‚Äì $1,200",
          "5": "$300 ‚Äì $800"
        },
        premium: {
          "1": "$2,800 ‚Äì $4,400",
          "2": "$2,000 ‚Äì $3,000",
          "3_repipe": "$1,800 ‚Äì $2,700",
          "3": "$1,500 ‚Äì $2,200",
          "4": "$1,000 ‚Äì $1,500",
          "5": "$400 ‚Äì $900"
        }
      }
    };

    // === üîÑ REPLACE OLD LOGIC FUNCTIONS WITH CLEAN MAP CALLS ===
    function getDifficulty(score) {
    return NeuraConfig.scoreDifficultyMap[String(score)] || "Unknown";
    }

    function getQuoteSummary(score, jobType) {
      const key = `${score}_${(jobType || "").toLowerCase()}`;
      return (
        NeuraConfig.quoteSummaryMap[key] ||
        NeuraConfig.quoteSummaryMap[String(score)] ||
        ""
      );
    }

    function getPriceRange(score, jobType, profile = "standard") {
      const s = String(score);
      const jt = String(jobType || "").toLowerCase();
      const p = String(profile);
      const key = s === "3" && jt === "repipe" ? "3_repipe" : s;
      return NeuraConfig.priceRanges[p]?.[key] || "Varies";
    }

    console.log("‚úÖ imageUrl param:", imageUrl);
    console.log("‚úÖ score param:", score);
    console.log("‚úÖ jobType param:", jobType);
    console.log("‚úÖ profile param:", profile);

    const img = document.getElementById("previewImage");
    const scoreDisplay = document.getElementById("scoreDisplay");

    if (imageUrl) {
      img.src = imageUrl;
      img.style.display = "block";
      img.style.borderRadius = "12px";
      img.style.marginTop = "20px";
    }

    if (score) {
      const badge = document.createElement("div");
      badge.textContent = `NeuraScore: ${score}`;
      badge.style.backgroundColor = getBadgeColor(score);
      badge.style.color = "white";
      badge.style.padding = "10px 20px";
      badge.style.borderRadius = "30px";
      badge.style.fontSize = "18px";
      badge.style.fontWeight = "bold";
      badge.style.display = "inline-block";
      badge.style.marginTop = "20px";
      badge.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
      scoreDisplay.appendChild(badge);
      const profileSelector = document.createElement("select");
      profileSelector.style.marginTop = "16px";
      profileSelector.style.padding = "6px";
      profileSelector.style.borderRadius = "6px";
      profileSelector.style.fontSize = "14px";

      ["standard", "premium"].forEach(option => {
        const opt = document.createElement("option");
        opt.value = option;
        opt.textContent = option.charAt(0).toUpperCase() + option.slice(1);
        profileSelector.appendChild(opt);
      });

      profileSelector.value = profile;
      scoreDisplay.appendChild(profileSelector);

      // === Premium Profile Visual Logic ===
      const profileVisualTag = document.createElement("div");
      profileVisualTag.style.marginTop = "8px";
      profileVisualTag.style.fontSize = "13px";
      profileVisualTag.style.fontWeight = "bold";
      profileVisualTag.style.color = "#444";
      scoreDisplay.appendChild(profileVisualTag);

      const trustContainer = document.createElement("div");
trustContainer.style.marginTop = "12px";
trustContainer.style.padding = "12px";
trustContainer.style.border = "1px solid #ddd";
trustContainer.style.borderRadius = "8px";
trustContainer.style.maxWidth = "300px";
trustContainer.style.background = "#fafafa";

const overrideToggle = document.createElement("button");
overrideToggle.textContent = "Enable Manual Override";
overrideToggle.style.marginTop = "16px";
overrideToggle.style.padding = "6px 12px";
overrideToggle.style.borderRadius = "6px";
overrideToggle.style.fontSize = "14px";
overrideToggle.style.cursor = "pointer";
overrideToggle.dataset.enabled = "false";

scoreDisplay.appendChild(overrideToggle);

const overrideInput = document.createElement("input");
overrideInput.id = "overrideInput";
overrideInput.type = "text";
overrideInput.placeholder = "e.g. $1,500 ‚Äì $2,600";
overrideInput.style.marginTop = "8px";
overrideInput.style.padding = "6px 12px";
overrideInput.style.borderRadius = "6px";
overrideInput.style.fontSize = "14px";
overrideInput.style.display = "none";

scoreDisplay.appendChild(overrideInput);
overrideInput.addEventListener("input", renderTrustQuote);

const saveOverrideButton = document.createElement("button");
saveOverrideButton.textContent = "Save Override to Vault";
saveOverrideButton.style.marginTop = "8px";
saveOverrideButton.style.padding = "6px 12px";
saveOverrideButton.style.borderRadius = "6px";
saveOverrideButton.style.fontSize = "14px";
saveOverrideButton.style.cursor = "pointer";
saveOverrideButton.style.display = "none";
scoreDisplay.appendChild(saveOverrideButton);

function renderTrustQuote() {
  const isManual = overrideToggle.dataset.enabled === "true";
  overrideInput.style.display = isManual ? "block" : "none";
  saveOverrideButton.style.display = isManual ? "inline-block" : "none";

  const selectedProfile = profileSelector.value;
  const laborRange = isManual && overrideInput.value
    ? overrideInput.value
    : getPriceRange(score, jobType, selectedProfile);
  trustContainer.innerHTML = `
   <div style="font-weight:bold;margin-bottom:6px;">TrustQuote</div>
  <div><strong>Difficulty:</strong> ${getDifficulty(score)}</div>
  <div><strong>Labor Range:</strong> ${laborRange}</div>
  <p style="font-style: italic; margin-top: 8px;">
    ${getQuoteSummary(score, jobType)}
  </p>
  `;

  // Show profile-based tier message
  profileVisualTag.innerHTML =
    selectedProfile === "premium"
      ? `<span style="color:#D48B00;">üíº Premium View: Higher expected labor tier</span>`
      : `<span style="color:#888;">Standard View</span>`
}

scoreDisplay.appendChild(trustContainer);
renderTrustQuote();
profileSelector.addEventListener("change", renderTrustQuote);

// === Add Explain Button Below TrustQuote ===
      const explainButton = document.createElement("button");
      explainButton.textContent = "üß† Why this score?";
      explainButton.style.marginTop = "16px";
      explainButton.style.padding = "6px 12px";
      explainButton.style.borderRadius = "6px";
      explainButton.style.fontSize = "14px";
      explainButton.style.cursor = "pointer";
      scoreDisplay.appendChild(explainButton);

      const explanationBox = document.createElement("div");
      explanationBox.style.marginTop = "12px";
      explanationBox.style.padding = "10px";
      explanationBox.style.background = "#f0f8ff";
      explanationBox.style.border = "1px solid #ccd";
      explanationBox.style.borderRadius = "6px";
      explanationBox.style.fontSize = "14px";
      explanationBox.style.display = "none";
      scoreDisplay.appendChild(explanationBox);

      // === Explanation Logic ===
      explainButton.addEventListener("click", () => {
        const s = String(score);
        const jt = String(jobType || "").toLowerCase();
        const p = profileSelector.value;

        let text = "";

        if (s === "1") text = "This score indicates severe risks such as leaks, code violations, or improper installation. Immediate action is recommended.";
        else if (s === "2") text = "The work appears below standard, potentially due to missing safeguards, exposed risk, or functional flaws.";
        else if (s === "3" && jt === "repipe") text = "Moderate complexity for a repipe usually involves trenching, rerouting, and managing inspections.";
        else if (s === "3") text = "This installation has moderate risk or effort involved. It's functional but may need closer inspection.";
        else if (s === "4") text = "This install shows clean, competent execution with low risk. Minimal labor concerns.";
        else if (s === "5") text = "This job meets elite standards with clean routing, full compliance, and zero visible faults.";

        if (p === "premium") text += " (You are viewing this as a Premium profile, which reflects higher labor expectations and margins.)";

        explanationBox.textContent = text;
        explanationBox.style.display = "block";
      });

overrideToggle.addEventListener("click", () => {
  const current = overrideToggle.dataset.enabled === "true";
  overrideToggle.dataset.enabled = (!current).toString();
  overrideToggle.textContent = current ? "Enable Manual Override" : "Disable Manual Override";
  overrideInput.style.display = overrideToggle.dataset.enabled === "true" ? "block" : "none";
  renderTrustQuote();
});

saveOverrideButton.addEventListener("click", async () => {
  const user = firebase.auth().currentUser;
  if (!user) return alert("Not signed in");

  const manualQuote = overrideInput.value;
  if (!manualQuote) return alert("Enter a value first");

  const docRef = firebase.firestore().collection("uploads").doc();
  await docRef.set({
    userId: user.uid,
    imageUrl: imageUrl || "",
    mockScore: score,
    jobType: jobType || "Unknown",
    profile: profileSelector.value || "standard",
    manualQuote: manualQuote,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  alert("‚úÖ Manual override saved to Vault");
});

const footer = document.createElement("div");
footer.style.marginTop = "16px";
footer.style.fontSize = "12px";
footer.style.color = "#888";
footer.style.textAlign = "right";
footer.textContent = "Powered by NeuraPlumb‚Ñ¢";

scoreDisplay.appendChild(footer);

const exportButton = document.createElement("button");
exportButton.textContent = "Export Quote";
exportButton.style.marginTop = "16px";
exportButton.style.padding = "6px 12px";
exportButton.style.borderRadius = "6px";
exportButton.style.fontSize = "14px";
exportButton.style.cursor = "pointer";
scoreDisplay.appendChild(exportButton);

const pdfButton = document.createElement("button");
pdfButton.textContent = "üìÑ Download PDF";
pdfButton.style.marginTop = "12px";
pdfButton.style.padding = "6px 12px";
pdfButton.style.borderRadius = "6px";
pdfButton.style.fontSize = "14px";
pdfButton.style.cursor = "pointer";
scoreDisplay.appendChild(pdfButton);

exportButton.addEventListener("click", () => {
  const content = `
    üõ†Ô∏è NeuraPlumb TrustQuote
    --------------------------
    Score: ${score}
    Difficulty: ${getDifficulty(score)}
    Labor Range: ${overrideToggle.dataset.enabled === "true" && overrideInput.value
      ? overrideInput.value
      : getPriceRange(score, jobType, profileSelector.value)}
    Job Type: ${jobType || 'N/A'}
    Profile: ${profileSelector.value}
    --------------------------
    ${getQuoteSummary(score, jobType)}
  `;
  const blob = new Blob([content], { type: "text/plain" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "TrustQuote.txt";
  a.click();
});

pdfButton.addEventListener("click", () => {
  const selectedProfile = profileSelector.value;
  const isManual = overrideToggle.dataset.enabled === "true";
  const laborRange = isManual && overrideInput.value
    ? overrideInput.value
    : getPriceRange(score, jobType, selectedProfile);

  const pdfContent = document.createElement("div");
  pdfContent.style.padding = "20px";
  pdfContent.style.fontFamily = "Arial";
  pdfContent.innerHTML = `
    <h2 style="margin-bottom: 8px;">üîß NeuraPlumb‚Ñ¢ TrustQuote</h2>
    <p><strong>NeuraScore:</strong> ${score}</p>
    <p><strong>Difficulty:</strong> ${getDifficulty(score)}</p>
    <p><strong>Labor Range:</strong> ${laborRange}</p>
    <p><strong>Job Type:</strong> ${jobType}</p>
    <p><strong>Profile:</strong> ${selectedProfile}</p>
    <p style="margin-top: 12px; font-style: italic;">
      ${getQuoteSummary(score, jobType)}
    </p>
    <hr />
    <p style="font-size:12px; color:#888; text-align:right;">
      Powered by NeuraPlumb‚Ñ¢
    </p>
  `;

  html2pdf()
    .from(pdfContent)
    .set({ filename: "TrustQuote.pdf" })
    .save();
});

}

// (Old logic functions removed; now defined above using NeuraConfig)


    async function loadVaultData() {
       const user = firebase.auth().currentUser;
      if (!user) return;

      const vaultContainer = document.getElementById('vault');
      vaultContainer.innerHTML = '';

      const jobFilter = document.getElementById('jobFilter')?.value || '';
      const profileFilter = document.getElementById('profileFilter')?.value || '';
      const tagFilter = document.getElementById('tagFilter')?.value || '';

      const querySnapshot = await firebase.firestore()
        .collection('uploads')
        .where('userId', '==', user.uid)
        .orderBy('timestamp', 'desc')
        .get();

      querySnapshot.forEach(doc => {
        const data = doc.data();
        const docId = doc.id;

        if (jobFilter && data.jobType !== jobFilter) return;
        if (profileFilter && data.profile !== profileFilter) return;

        const tag =
          data.mockScore === '5' && !data.manualQuote ? 'Elite' :
          (data.mockScore === '1' || data.mockScore === '2') ? 'NeedsReview' :
          data.manualQuote ? 'Reviewed' : '';

        if (tagFilter && tag !== tagFilter) return;

        const jobColorMap = {
          Repipe: '#ffd54f',
          Sewer: '#81c784',
          WaterHeater: '#4fc3f7',
          Drain: '#ff8a65',
          Inspection: '#ce93d8'
        };
        const tagColor = jobColorMap[data.jobType] || '#eee';

        const card = document.createElement('div');
        card.classList.add('vault-card');
        card.innerHTML = `
          <img src="${data.imageUrl}" alt="Plumbing Photo" class="vault-thumb" />
          <div class="vault-info">
            <div><strong>Score:</strong> ${data.mockScore}</div>
            ${data.manualQuote ? `<div><strong>Manual Quote:</strong> <span id="quote-${docId}">${data.manualQuote}</span></div>` : ''}
            ${data.locked ? `<div style="color:red;font-weight:bold;">üîí Locked</div>` : ''}
            <div>
              <strong>Job Type:</strong>
              <span style="padding:2px 6px; border-radius:6px; background:${tagColor}; font-size:12px; font-weight:bold;">
                ${data.jobType || 'N/A'}
              </span>
            </div>
            <div><strong>Profile:</strong> ${data.profile || 'standard'}</div>
            <div><strong>Status:</strong> ${tag}</div>
            <div><strong>Date:</strong> ${new Date(data.timestamp?.toDate()).toLocaleString()}</div>
            <button style="margin-top: 6px;" onclick="editManualQuote('${docId}', ${!!data.locked})" ${data.locked ? 'disabled' : ''}>
              Edit Quote
            </button>
            <button style="margin-left: 6px;" onclick="toggleLock('${docId}', ${!!data.locked})">
              ${data.locked ? 'Unlock' : 'Lock'}
            </button>
          </div>
        `;
        vaultContainer.appendChild(card);

        card.addEventListener("click", () => {
          const params = new URLSearchParams();
          if (data.imageUrl) params.set("imgUrl", data.imageUrl);
          if (data.mockScore) params.set("score", data.mockScore);
          if (data.jobType) params.set("jobType", data.jobType);
          if (data.profile) params.set("profile", data.profile);
          window.location.href = `vault.html?${params.toString()}`;
        });
      });
    }
window.editManualQuote = async function(docId, isLocked) {
  if (isLocked) return alert("Quote is locked.");
  const newQuote = prompt("Enter new manual quote:");
  if (newQuote === null) return;
  await firebase.firestore().collection('uploads').doc(docId).update({
    manualQuote: newQuote,
    lastEdited: firebase.firestore.FieldValue.serverTimestamp()
  });
  const quoteSpan = document.getElementById(`quote-${docId}`);
  if (quoteSpan) quoteSpan.textContent = newQuote;
  alert("‚úÖ Manual quote updated.");
};

window.toggleLock = async function(docId, currentState) {
  await firebase.firestore().collection('uploads').doc(docId).update({
    locked: !currentState
  });
  alert(currentState ? "üîì Unlocked" : "üîí Locked");
  loadVaultData();
};
    firebase.auth().signInWithEmailAndPassword("jaymz6435@gmail.com", "Elara572025!")
  .then(() => console.log("‚úÖ Signed in manually"))
  .catch(err => console.error("‚ùå Sign-in failed:", err));
    
firebase.auth().onAuthStateChanged(user => {
      console.log("üë§ Signed-in user:", user ? user.uid : "None");
  if (user) {
    loadVaultData();
  }
});
    // === Auto-refresh filters on change ===
  ["jobFilter", "profileFilter", "tagFilter"].forEach(id => {
    document.getElementById(id)?.addEventListener("change", loadVaultData);
  });
  function getBadgeColor(score) {
  const s = String(score); // Normalize to string
  switch (s) {
    case "1": return "red";
    case "2": return "orange";
    case "3": return "yellow";
    case "4": return "green";
    case "5": return "blue";
    default: return "gray";
  }
}
  </script>
</body>
</html>
