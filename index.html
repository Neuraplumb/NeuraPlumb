<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NeuraPlumb Scoring Tool</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    img#preview {
      display: none;
      margin-bottom: 10px;
      width: 300px;
      height: auto;
      border-radius: 10px;
    }
    .score-box {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      font-weight: bold;
      text-align: center;
    }
    .score-1 { background-color: #f44336; color: white; }
    .score-2 { background-color: #ff9800; color: white; }
    .score-3 { background-color: #ffeb3b; color: black; }
    .score-4 { background-color: #2196f3; color: white; }
    .score-5 { background-color: #4caf50; color: white; }
  </style>
</head>
<body>
  <h1>NeuraPlumb Scoring Tool</h1>

  <label for="photo">Upload Photo:</label>
  <input type="file" id="photo" accept="image/jpeg,image/png" />
  <br /><br />

  <img id="preview" alt="Preview" />

  <label for="job">Job Type:</label>
  <select id="job">
    <option value="">Select Job Type</option>
    <option value="water_heater">Water Heater</option>
    <option value="sewer">Sewer</option>
    <option value="repipe">Copper Repipe</option>
    <option value="drain">Drain Repair</option>
  </select>
  <br /><br />

  <label for="scope">Scope of Work:</label>
  <select id="scope">
    <option value="">Select Scope</option>
    <option value="full_install">Full Install</option>
    <option value="replacement">Replacement</option>
    <option value="repair_only">Repair Only</option>
  </select>
  <br /><br />

  <button onclick="handleUpload()">Get NeuraScore</button>
  <div id="result" class="score-box"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBzkTSn1Xec-kGSHPahtCQ-nhmni3qzAIs",
      authDomain: "neuraplumb-temp.firebaseapp.com",
      projectId: "neuraplumb-temp",
      storageBucket: "neuraplumb-temp.appspot.com",
      messagingSenderId: "329025414261",
      appId: "1:329025414261:web:547b1254f89215b82d443c"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);
    const db = getFirestore(app);

    const photoInput = document.getElementById("photo");
    const preview = document.getElementById("preview");
    const result = document.getElementById("result");

    signInWithEmailAndPassword(auth, "jaymz6435@gmail.com", "Elara572025!")
      .then(() => console.log("‚úÖ Signed in to Firebase"))
      .catch(err => alert("Login error: " + err.message));

    photoInput.addEventListener("change", () => {
      const file = photoInput.files[0];
      if (file && file.type.startsWith("image/")) {
        preview.src = URL.createObjectURL(file);
        preview.style.display = "block";
      }
    });

    window.handleUpload = async () => {
      const file = photoInput.files[0];
      const job = document.getElementById("job").value;
      const scope = document.getElementById("scope").value;

      if (!file || !job || !scope) {
        alert("Please select a photo, job type, and scope.");
        return;
      }

      const user = auth.currentUser;
      const storageRef = ref(storage, `uploads/${file.name}`);
      await uploadBytes(storageRef, file);
      console.log("‚úÖ Upload successful");

      const imageUrl = await getDownloadURL(storageRef);
    await addDoc(collection(db, "uploads"), {
      uid: user.uid,
      fileName: file.name,
      jobType: job,
      scope: scope,
      imageUrl, // ‚úÖ use the result from getDownloadURL() ‚Äî not a manual string
      timestamp: serverTimestamp()
    });      
      console.log("üì¶ Logged to Firestore");

      const mockScore = Math.floor(Math.random() * 5) + 1;
      const messages = [
        "1 ‚Äì ‚ö†Ô∏è Issues detected. Review recommended.",
        "2 ‚Äì Basic install with minor concerns.",
        "3 ‚Äì Standard install. Acceptable performance.",
        "4 ‚Äì ‚úÖ Clean and professional workmanship.",
        "5 ‚Äì üåü Elite work. NeuraPlumb verified."
      ];
      const classes = ["score-1", "score-2", "score-3", "score-4", "score-5"];
      result.className = `score-box ${classes[mockScore - 1]}`;
      result.textContent = `NeuraScore: ${messages[mockScore - 1]}`;

      loadRecentUploads(); // refresh history
    };

    async function loadRecentUploads() {
      const user = auth.currentUser;
      if (!user) return;

      const q = query(
        collection(db, "uploads"),
        where("uid", "==", user.uid),
        orderBy("timestamp", "desc"),
        limit(5)
      );

      const querySnapshot = await getDocs(q);
      const container = document.createElement("div");
      container.innerHTML = "<h3>Your Recent Uploads</h3>";
      querySnapshot.forEach((doc) => {
        const data = doc.data();
        const div = document.createElement("div");
        div.innerHTML = `
          <p><strong>${data.jobType}</strong> ‚Äì ${data.scope}</p>
          <img src="${data.imageUrl}" width="150" style="border-radius: 6px;" />
          <hr />
        `;
        container.appendChild(div);
      });

      document.body.appendChild(container);
    }

    window.addEventListener("load", () => {
      onAuthStateChanged(auth, (user) => {
        if (user) loadRecentUploads();
      });
    });
  </script>
</body>
</html>
