<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vault Placeholder</title>
</head>
<body>
  <img id="previewImage" src="" alt="Job Preview" width="300" style="display: none;" />
  <div id="scoreDisplay" style="margin-top: 20px;"></div>

  <h1>Vault Placeholder</h1>
  <p>This is where TrustQuote will live.</p>

  <h2>Your Vault</h2>
  <div id="vault">
    <!-- Example vault cards (add as many as you need) -->
    <div class="vault-card" 
         data-score="3" 
         data-jobtype="Repipe" 
         data-profile="premium" 
         data-docid="2vgl10FZo1KPfal6PGtb"
         style="margin-bottom:24px;padding:16px;border:1px solid #eee;border-radius:8px;">
      <div><strong>Job:</strong> Repipe</div>
      <div><strong>Score:</strong> 3</div>
      <div><strong>Profile:</strong> premium</div>
      <div class="trustquote" style="margin-top:12px;"></div>
    </div>
    <div class="vault-card" 
         data-score="5" 
         data-jobtype="Water Heater" 
         data-profile="standard" 
         data-docid="sSUWFTZYO91Qrn6c9dmF"
         style="margin-bottom:24px;padding:16px;border:1px solid #eee;border-radius:8px;">
      <div><strong>Job:</strong> Water Heater</div>
      <div><strong>Score:</strong> 5</div>
      <div><strong>Profile:</strong> standard</div>
      <div class="trustquote" style="margin-top:12px;"></div>
    </div>
    <!-- Add more .vault-card blocks as needed, each with data-docid -->
  </div>

    <!-- Add more .vault-card blocks as needed, each with data-docid -->
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-functions.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBzkTSn1Xec-kGSHPahtCQ-nhmni3qzAIs",
      authDomain: "neuraplumb-temp.firebaseapp.com",
      projectId: "neuraplumb-temp",
      storageBucket: "neuraplumb-temp.appspot.com",
      messagingSenderId: "496029226738",
      appId: "1:496029226738:web:f837e91b9df82ad78b1b9b"
    };

    // Initialize Firebase only once
    let app;
    try { app = initializeApp(firebaseConfig); } catch (e) {}
    const auth = getAuth();
    const db = getFirestore();
    const functions = getFunctions();

    // Handle preview image and score badge from URL params
    const params = new URLSearchParams(window.location.search);
    const imageUrl = params.get("imgUrl") || "";
    const score = params.get("score") || null;
    const jobType = params.get("jobType") || null;
    const profile = params.get("profile") || "standard";

    const img = document.getElementById("previewImage");
    const scoreDisplay = document.getElementById("scoreDisplay");

    if (imageUrl) {
      img.src = imageUrl;
      img.style.display = "block";
      img.style.borderRadius = "12px";
      img.style.marginTop = "20px";
    }

    if (score) {
      const badge = document.createElement("div");
      badge.textContent = `NeuraScore: ${score}`;
      badge.style.backgroundColor = "#1e88e5";
      badge.style.padding = "10px 20px";
      badge.style.color = "white";
      badge.style.borderRadius = "30px";
      badge.style.fontSize = "18px";
      badge.style.fontWeight = "bold";
      scoreDisplay.appendChild(badge);
    }

    // TrustQuote logic for all vault cards
    const trustQuoteCache = {};
    function getCacheKey(score, jobType, profile, docId) {
      return `${score}|${jobType}|${profile}|${docId}`;
    }

    document.querySelectorAll('.vault-card').forEach(async (card) => {
      const score = card.dataset.score;
      const jobType = card.dataset.jobtype;
      const profile = card.dataset.profile;
      const docId = card.dataset.docid;
      const trustDiv = card.querySelector('.trustquote');
      if (!trustDiv || !docId) return;

      const cacheKey = getCacheKey(score, jobType, profile, docId);

      if (trustQuoteCache[cacheKey]) {
        trustDiv.innerHTML = `
          <div style="white-space:pre-line;line-height:1.6;margin-bottom:8px;">
            ${trustQuoteCache[cacheKey]}
          </div>
          <div style="font-size:12px;color:#999;">Powered by <strong>NeuraPlumb</strong></div>
        `;
        return;
      }

      trustDiv.innerHTML = `<em>Loading TrustQuote...</em>`;

      try {
        const explainQuote = httpsCallable(functions, "explainQuote");
        // Pass docId in the call
        const res = await explainQuote({ score, jobType, profile, docId });
        const explanation = res.data.explanation || "No explanation returned.";
        trustQuoteCache[cacheKey] = explanation;
        trustDiv.innerHTML = `
          <div style="white-space:pre-line;line-height:1.6;margin-bottom:8px;">
            ${explanation}
          </div>
          <div style="font-size:12px;color:#999;">Powered by <strong>NeuraPlumb</strong></div>
        `;
      } catch (err) {
        trustDiv.innerHTML = `<span style="color:#b71c1c;">⚠️ Could not load TrustQuote.</span>`;
        console.error("TrustQuote error:", err);
      }
    });
  </script>
</body>
</html>